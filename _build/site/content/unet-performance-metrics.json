{"version":3,"kind":"Notebook","sha256":"52c850f4563f9958f89fbae21c761b57be3b7b9801c7f8c111915e693dd81223","slug":"unet-performance-metrics","location":"/notebooks/Amanda/unet_performance_metrics.ipynb","dependencies":[],"frontmatter":{"title":"Assessing network performance","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"pytorch","language":"python"},"authors":[{"id":"Amanda M. Thomas, William Marfo, and Loïc Bachelot","name":"Amanda M. Thomas, William Marfo, and Loïc Bachelot"}],"keywords":["earthquake","catalog","ML","AI"],"numbering":{"title":{"offset":1}},"thumbnail":"/92e2551add9c1d800cc2a7a5df7dd35c.png","exports":[{"format":"ipynb","filename":"unet_performance_metrics.ipynb","url":"/unet_performance_met-4b227cf9ee540b61c055cbc485b3b62f.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Author:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"hshuIRO6dI"}],"key":"ageDmKJpeP"},{"type":"text","value":" Amanda M. Thomas","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"vIvECaJ6ZY"},{"type":"break","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"hNRMbi4YSV"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Goal:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"N6tRowD8T6"}],"key":"hCDG8J7GuK"},{"type":"text","value":" This notebook computes some metrics commonly used to assess network performance.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"uM6bJIpDI8"}],"key":"jWiCDthBTc"},{"type":"thematicBreak","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"K0ChK2QF3S"}],"key":"Enzq8ZY2kc"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import torch\nimport torch.nn as nn\nimport torch.nn.functional as F\nfrom torchsummary import summary\nimport matplotlib.pyplot as plt\nimport numpy as np\nimport time\nimport seisbench.data as sbd\nimport seisbench.models as sbm\nfrom torch.utils.data import random_split, DataLoader\nimport seisbench.generate as sbg\nimport pandas as pd\nfrom scipy.signal import find_peaks\nfrom obspy import Trace, Stream\n\n# Set seeds\nnp.random.seed(42)\ntorch.manual_seed(42)","key":"oIU2iq5kgi"},{"type":"outputs","id":"yL8jLmjFnJbXIyZk22PeR","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":4,"metadata":{},"data":{"text/plain":{"content":"<torch._C.Generator at 0x11a6c79f0>","content_type":"text/plain"}}},"children":[],"key":"t1KSpCPsBz"}],"key":"mooZQ0O6eE"}],"key":"HSW5ypjx01"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"1. Load the U-Net Architecture","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WAwUVjqz80"}],"identifier":"id-1-load-the-u-net-architecture","label":"1. Load the U-Net Architecture","html_id":"id-1-load-the-u-net-architecture","implicit":true,"key":"ImKksuKbuT"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"We need to first load in the network architecture.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"U7TFCkXwNi"}],"key":"pWBr92M5PQ"}],"key":"xBkN4PTWwC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Cell 2: U-Net Building Blocks\nclass ConvBlock(nn.Module):\n    def __init__(self, in_channels, out_channels, kernel_size=3, padding=1):\n        super().__init__()\n        self.conv = nn.Sequential(\n            nn.Conv1d(in_channels, out_channels, kernel_size, padding=padding),\n            nn.ReLU(),\n            nn.Conv1d(out_channels, out_channels, kernel_size, padding=padding),\n            nn.ReLU()\n        )\n\n    def forward(self, x):\n        return self.conv(x)\n\nclass UNet1D(nn.Module):\n    def __init__(self, in_channels=3, out_channels=3, features=[16, 32, 64, 128]):\n        super().__init__()\n        \n        self.downs = nn.ModuleList()  # Encoder blocks (downsampling path)\n        self.ups = nn.ModuleList()    # Decoder blocks (upsampling path)\n    \n        # ----- Encoder: Downsampling Path -----\n        # Each ConvBlock halves the temporal resolution via pooling (done in forward),\n        # and increases the number of feature channels.\n        for feat in features:\n            self.downs.append(ConvBlock(in_channels, feat))  # ConvBlock: Conv + ReLU + Conv + ReLU\n            in_channels = feat  # Update in_channels for the next block\n    \n        # ----- Bottleneck -----\n        # Deepest layer in the U-Net, connects encoder and decoder\n        self.bottleneck = ConvBlock(features[-1], features[-1]*2)\n    \n        # ----- Decoder: Upsampling Path -----\n        # Reverse features list for symmetrical decoder\n        rev_feats = features[::-1]\n        for feat in rev_feats:\n            # First upsample (via transposed convolution)\n            self.ups.append(\n                nn.ConvTranspose1d(feat*2, feat, kernel_size=2, stride=2)\n            )\n            # Then apply ConvBlock: input has double channels due to skip connection\n            self.ups.append(ConvBlock(feat*2, feat))\n    \n        # ----- Final Output Convolution -----\n        # 1x1 convolution to map to desired output channels (e.g., P, S, noise)\n        self.final_conv = nn.Conv1d(features[0], out_channels, kernel_size=1)\n\n    def forward(self, x):\n        skip_connections = []\n\n        for down in self.downs:\n            x = down(x)\n            skip_connections.append(x)\n            x = F.max_pool1d(x, kernel_size=2)\n\n        x = self.bottleneck(x)\n        skip_connections = skip_connections[::-1]\n\n        for idx in range(0, len(self.ups), 2):\n            x = self.ups[idx](x)\n            skip_conn = skip_connections[idx//2]\n            if x.shape[-1] != skip_conn.shape[-1]:\n                x = F.pad(x, (0, skip_conn.shape[-1] - x.shape[-1]))\n            x = torch.cat((skip_conn, x), dim=1)\n            x = self.ups[idx+1](x)\n        x = self.final_conv(x)\n        return F.softmax(x, dim=1)","key":"QH7G7kPvyL"},{"type":"outputs","id":"HAj0WU3kdbpyiYFA9kdGR","children":[],"key":"hkShm8evZO"}],"key":"dRZfwUmcGY"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We then intialize the model and load in the model weights.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NtoO1SZV4V"}],"key":"Ij26VOOR7I"}],"key":"CxwESZ46FR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model = UNet1D()\n\n# This cell loads the saved weights into the model.\nmodel.load_state_dict(torch.load(\"../Loic/UNet/model_weights_eq_only_v2.pt\",weights_only=True, map_location=torch.device('cpu')))\nmodel.eval() ","key":"znBbMIqEMJ"},{"type":"outputs","id":"MSLeFO6zWYHeAU2a4ZKKL","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":6,"metadata":{},"data":{"text/plain":{"content":"UNet1D(\n  (downs): ModuleList(\n    (0): ConvBlock(\n      (conv): Sequential(\n        (0): Conv1d(3, 16, kernel_size=(3,), stride=(1,), padding=(1,))\n        (1): ReLU()\n        (2): Conv1d(16, 16, kernel_size=(3,), stride=(1,), padding=(1,))\n        (3): ReLU()\n      )\n    )\n    (1): ConvBlock(\n      (conv): Sequential(\n        (0): Conv1d(16, 32, kernel_size=(3,), stride=(1,), padding=(1,))\n        (1): ReLU()\n        (2): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(1,))\n        (3): ReLU()\n      )\n    )\n    (2): ConvBlock(\n      (conv): Sequential(\n        (0): Conv1d(32, 64, kernel_size=(3,), stride=(1,), padding=(1,))\n        (1): ReLU()\n        (2): Conv1d(64, 64, kernel_size=(3,), stride=(1,), padding=(1,))\n        (3): ReLU()\n      )\n    )\n    (3): ConvBlock(\n      (conv): Sequential(\n        (0): Conv1d(64, 128, kernel_size=(3,), stride=(1,), padding=(1,))\n        (1): ReLU()\n        (2): Conv1d(128, 128, kernel_size=(3,), stride=(1,), padding=(1,))\n        (3): ReLU()\n      )\n    )\n  )\n  (ups): ModuleList(\n    (0): ConvTranspose1d(256, 128, kernel_size=(2,), stride=(2,))\n    (1): ConvBlock(\n      (conv): Sequential(\n        (0): Conv1d(256, 128, kernel_size=(3,), stride=(1,), padding=(1,))\n        (1): ReLU()\n        (2): Conv1d(128, 128, kernel_size=(3,), stride=(1,), padding=(1,))\n        (3): ReLU()\n      )\n    )\n    (2): ConvTranspose1d(128, 64, kernel_size=(2,), stride=(2,))\n    (3): ConvBlock(\n      (conv): Sequential(\n        (0): Conv1d(128, 64, kernel_size=(3,), stride=(1,), padding=(1,))\n        (1): ReLU()\n        (2): Conv1d(64, 64, kernel_size=(3,), stride=(1,), padding=(1,))\n        (3): ReLU()\n      )\n    )\n    (4): ConvTranspose1d(64, 32, kernel_size=(2,), stride=(2,))\n    (5): ConvBlock(\n      (conv): Sequential(\n        (0): Conv1d(64, 32, kernel_size=(3,), stride=(1,), padding=(1,))\n        (1): ReLU()\n        (2): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(1,))\n        (3): ReLU()\n      )\n    )\n    (6): ConvTranspose1d(32, 16, kernel_size=(2,), stride=(2,))\n    (7): ConvBlock(\n      (conv): Sequential(\n        (0): Conv1d(32, 16, kernel_size=(3,), stride=(1,), padding=(1,))\n        (1): ReLU()\n        (2): Conv1d(16, 16, kernel_size=(3,), stride=(1,), padding=(1,))\n        (3): ReLU()\n      )\n    )\n  )\n  (bottleneck): ConvBlock(\n    (conv): Sequential(\n      (0): Conv1d(128, 256, kernel_size=(3,), stride=(1,), padding=(1,))\n      (1): ReLU()\n      (2): Conv1d(256, 256, kernel_size=(3,), stride=(1,), padding=(1,))\n      (3): ReLU()\n    )\n  )\n  (final_conv): Conv1d(16, 3, kernel_size=(1,), stride=(1,))\n)","content_type":"text/plain"}}},"children":[],"key":"a90qn77pV8"}],"key":"R2Am6j0fug"}],"key":"TOauY3aLIf"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2. Load the dataset from the current directory","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VPG2Sigpq1"}],"identifier":"id-2-load-the-dataset-from-the-current-directory","label":"2. Load the dataset from the current directory","html_id":"id-2-load-the-dataset-from-the-current-directory","implicit":true,"key":"rPtLCIVArT"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Loads the “meso” PNW dataset.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Y7x4h271BK"}],"key":"B5cujQs4lu"}],"key":"ft7zHSGkQv"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#data = sbd.WaveformDataset(\"../data/waveform_dataset/\", component_order=\"ENZ\")\ndata = sbd.WaveformDataset(\"../../../shared/shortcourses/crescent_ml_2025/miniseed/\", component_order=\"ENZ\")\ndata._metadata = data.metadata[data.metadata.source_type == \"earthquake\"].reset_index(drop=True)\nprint(data.metadata[\"source_type\"].value_counts())","key":"adLO2OTY9Y"},{"type":"outputs","id":"2u5fHFI7k3qi1DOxH85qg","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-05-09 22:15:33,007 | seisbench | WARNING | Dimension order not specified in data set. Assuming CW.\n"},"children":[],"key":"VWAyecupl7"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"source_type\nearthquake    17960\nName: count, dtype: int64\n"},"children":[],"key":"UDTUndfLqw"}],"key":"VkhRJ9As59"}],"key":"STRQt6YIkV"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define the test dataset and the labels.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"N2DZo6VjJo"}],"key":"Su8hN7LdoP"}],"key":"oZA0ZGPxBT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"test = data.test()\n\nphase_dict = {\"trace_P_arrival_sample\": \"P\",\n              \"trace_S_arrival_sample\": \"S\"}\n\nmodel_labels = [\"P\", \"S\", \"noise\"]","key":"HT7gUtZQ9i"},{"type":"outputs","id":"HE0pXh59uHwlCQxu8-dx3","children":[],"key":"n9a3ylGDuD"}],"key":"GewijEMSfe"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"3. Set up and test the generator","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zuRPw5xXb0"}],"identifier":"id-3-set-up-and-test-the-generator","label":"3. Set up and test the generator","html_id":"id-3-set-up-and-test-the-generator","implicit":true,"key":"ZS1r73uCin"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Set up generator.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"OIkQbhBCh5"}],"key":"NYXarIT1uv"}],"key":"keooezF9i1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"test_generator = sbg.GenericGenerator(test)\n\naugmentations = [\n    sbg.WindowAroundSample(\n        list(phase_dict.keys()), samples_before=3000, windowlen=6000,\n        selection=\"random\", strategy=\"variable\"\n    ),\n    sbg.RandomWindow(windowlen=3001, strategy=\"pad\"),\n    sbg.Normalize(demean_axis=-1, amp_norm_axis=-1, amp_norm_type=\"peak\"),\n    sbg.ChangeDtype(np.float32),\n    sbg.ProbabilisticLabeller(label_columns=phase_dict, model_labels=model_labels, sigma=30, dim=0)\n]\n\ntest_generator.add_augmentations(augmentations)","key":"M7dRjX7371"},{"type":"outputs","id":"rAh_6z8L8noGGAIfB_qn9","children":[],"key":"BakNWwG7tq"}],"key":"otGe6K3oEH"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Plot generator output.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DmvVD05Qrq"}],"key":"T1H4CxJhZC"}],"key":"selM1Ml8Os"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sample_id = 4\nsample = test_generator[sample_id]\n# Plot timeseries\nfig = plt.figure(figsize=(15, 10))\naxs = fig.subplots(2, 1, sharex=True, gridspec_kw={\"hspace\": 0, \"height_ratios\": [3, 1]})\naxs[0].plot(sample[\"X\"][0].T,label='E',color=\"tab:red\")\naxs[0].plot(sample[\"X\"][1].T,label='N',color=\"tab:blue\")\naxs[0].plot(sample[\"X\"][2].T,label='Z',color=\"tab:grey\")\naxs[0].legend()\naxs[1].plot(sample[\"y\"][0].T,label='P-wave',color=\"tab:red\")\naxs[1].plot(sample[\"y\"][1].T,label='S-wave',color=\"tab:blue\")\naxs[1].plot(sample[\"y\"][2].T,label='Noise',color=\"tab:grey\")\naxs[1].set_xlabel('Time (s)',fontsize=14)\naxs[1].set_ylabel('Target Amplitude',fontsize=14)\naxs[0].set_ylabel('Amplitude',fontsize=14)\naxs[1].set_xlim((0,3000))\naxs[1].legend()","key":"SZ4G8ApJmr"},{"type":"outputs","id":"3Q0Mh77L_PKmcLm5sToYt","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"10c36eaa4667154a8c6c1ec0fb35dade","path":"/10c36eaa4667154a8c6c1ec0fb35dade.png"},"text/plain":{"content":"<Figure size 1500x1000 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"MugK0qNqwu"}],"key":"wk0qVW1MYo"}],"key":"GKjxyuXzBD"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"4. Make test predictions","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TbXjDNXhGm"}],"identifier":"id-4-make-test-predictions","label":"4. Make test predictions","html_id":"id-4-make-test-predictions","implicit":true,"key":"V1AncmeceF"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Next we make predictions on the test set.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"DHATikxu4j"}],"key":"r7j1xKz7U7"}],"key":"LjDiHgkOZ3"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# seisbench prediction?\nseisbench_pred=True\nif seisbench_pred:\n    pn_model = sbm.PhaseNet.from_pretrained(\"original\")\n\n# Define a lambda that returns the index of where the timeseries is maximum\ndef idx_max(ts):\n    indices = np.where(ts == np.max(ts))[0]\n    return indices[0], ts[indices[0]]\n\n# Generate augmented samples and log their stats\ntargets =[]\npredictions = []\nfor ii in range(len(test)):\n    # Initialize variables\n    p_idx_max, p_val_max, s_idx_max, s_val_max, p_pred_idx_max, s_pred_idx_max, largest_ppeak_idx, largest_speak_idx = -1, -1, -1, -1, -1, -1, -1, -1\n    # Get the sample\n    sample = test_generator[ii]\n    if seisbench_pred:\n        st=Stream()\n        for cc, ch in enumerate(['E', 'N', 'Z']):\n            trace = Trace(data=np.pad(sample['X'][cc], (250, 250), mode='constant', constant_values=0))\n            trace.stats.sampling_rate = 100\n            trace.stats.channel = ch\n            st += trace\n        preds = pn_model.annotate(st)\n        noise_pred = preds[0].data\n        p_pred = preds[1].data\n        s_pred = preds[2].data\n    else:\n        with torch.no_grad():\n            pred = model(torch.tensor(sample[\"X\"], device=torch.device('cpu')).unsqueeze(0))  # Add a fake batch dimension\n            p_pred, s_pred, noise_pred = pred[0].cpu().numpy()\n\n    # Find the index of the maximum value in the analyist target\n    p_idx_max, p_val_max = idx_max(sample[\"y\"][0])\n    s_idx_max, s_val_max = idx_max(sample[\"y\"][1])\n\n    # Find the index of the maximum value in the prediction\n    p_pred_idx_max, _ = find_peaks(p_pred, height=0.05, distance=100) \n    s_pred_idx_max, _ = find_peaks(s_pred, height=0.05, distance=100) \n\n    # ------------ There is a P-wave prediction and a P-wave target ------------ \n    if len(p_pred_idx_max) > 0 and p_val_max == 1:\n        largest_ppeak_idx = p_pred_idx_max[np.argmax(p_pred[p_pred_idx_max])]\n        predictions.append({\"trace_id\": ii,\n                    \"pred_max_idx\": largest_ppeak_idx, \n                    \"pred_val\": p_pred[largest_ppeak_idx],\n                    \"phase\": \"P\"})         \n        targets.append({\"trace_id\": ii,\n                        \"max_idx\": p_idx_max,\n                        \"phase\": \"P\"})\n    # There is a P-wave prediction and no P-wave target --> false positive > dt / true negative if < dt\n    elif len(p_pred_idx_max) > 0 and p_val_max != 1:    \n        largest_ppeak_idx = p_pred_idx_max[np.argmax(p_pred[p_pred_idx_max])]\n        predictions.append({\"trace_id\": ii,\n                    \"pred_max_idx\": largest_ppeak_idx, \n                    \"pred_val\": p_pred[largest_ppeak_idx],\n                    \"phase\": \"P\"})         \n        targets.append({\"trace_id\": ii,\n                        \"max_idx\": np.nan,\n                        \"phase\": \"P\"})\n    # There is no P-wave prediction and a P-wave target --> false negative\n    elif len(p_pred_idx_max) == 0 and p_val_max == 1:\n        predictions.append({\"trace_id\": ii,\n                    \"pred_max_idx\": np.nan, \n                    \"pred_val\": np.nan,\n                    \"phase\": \"P\"})         \n        targets.append({\"trace_id\": ii,\n                        \"max_idx\": p_idx_max,\n                        \"phase\": \"P\"})\n    # There is no P-wave prediction and no P-wave target --> true negative\n    else:\n        predictions.append({\"trace_id\": ii,\n                    \"pred_max_idx\": np.nan, \n                    \"pred_val\": np.nan,\n                    \"phase\": \"P\"})         \n        targets.append({\"trace_id\": ii,\n                        \"max_idx\": np.nan,\n                        \"phase\": \"P\"})\n        \n    # ------------  There is a S-wave prediction and a S-wave target ------------ \n    if len(s_pred_idx_max) > 0 and s_val_max == 1:\n        targets.append({\"trace_id\": ii,\n                        \"max_idx\": s_idx_max,\n                        \"phase\": \"S\"})\n        largest_speak_idx = s_pred_idx_max[np.argmax(s_pred[s_pred_idx_max])]\n        predictions.append({\"trace_id\": ii,\n                    \"pred_max_idx\": largest_speak_idx, \n                    \"pred_val\": s_pred[largest_speak_idx],\n                    \"phase\": \"S\"})\n    # There is a S-wave prediction and no S-wave target --> false positive > dt / true negative if < dt\n    elif len(s_pred_idx_max) > 0 and s_val_max != 1:    \n        largest_speak_idx = s_pred_idx_max[np.argmax(s_pred[s_pred_idx_max])]\n        predictions.append({\"trace_id\": ii,\n                    \"pred_max_idx\": largest_speak_idx, \n                    \"pred_val\": s_pred[largest_speak_idx],\n                    \"phase\": \"S\"})         \n        targets.append({\"trace_id\": ii,\n                        \"max_idx\": np.nan,\n                        \"phase\": \"S\"})\n    # There is no S-wave prediction and a S-wave target --> false negative\n    elif len(s_pred_idx_max) == 0 and s_val_max == 1:\n        predictions.append({\"trace_id\": ii,\n                    \"pred_max_idx\": np.nan, \n                    \"pred_val\": np.nan,\n                    \"phase\": \"S\"})         \n        targets.append({\"trace_id\": ii,\n                        \"max_idx\": s_idx_max,\n                        \"phase\": \"S\"})\n    # There is no S-wave prediction and no S-wave target --> true negative\n    else:\n        predictions.append({\"trace_id\": ii,\n                    \"pred_max_idx\": np.nan, \n                    \"pred_val\": np.nan,\n                    \"phase\": \"S\"})         \n        targets.append({\"trace_id\": ii,\n                        \"max_idx\": np.nan,\n                        \"phase\": \"S\"})\n\n    # Plot some examples\n    if ii<10:\n        # Plot waveforms\n        fig = plt.figure(figsize=(15, 10))\n        axs = fig.subplots(2, 1, sharex=True, gridspec_kw={\"hspace\": 0, \"height_ratios\": [3, 1]})\n        axs[0].plot(sample[\"X\"][0].T,label='E',color=\"tab:red\")\n        axs[0].plot(sample[\"X\"][1].T,label='N',color=\"tab:blue\")\n        axs[0].plot(sample[\"X\"][2].T,label='Z',color=\"tab:grey\")\n        axs[0].text(20,-0.83, f\"P-wave target: {targets[-2][\"max_idx\"]}\", fontsize=10)\n        axs[0].text(20,-0.88, f\"P-wave prediction: {predictions[-2][\"pred_max_idx\"]}\", fontsize=10)\n        axs[0].text(20,-0.93, f\"S-wave target: {targets[-1][\"max_idx\"]}\", fontsize=10)\n        axs[0].text(20,-0.98, f\"S-wave prediction: {predictions[-1][\"pred_max_idx\"]}\", fontsize=10)\n        axs[0].set_ylim((-1,1))\n        # Plot target timeseries\n        axs[1].plot(sample[\"y\"][0].T,label='P-wave target', color=\"tab:red\")\n        axs[1].plot(sample[\"y\"][1].T,label='S-wave target', color='tab:blue')\n        if p_val_max == 1:\n            axs[1].plot(targets[-2][\"max_idx\"], sample[\"y\"][0][targets[-2][\"max_idx\"]], 'o', label='Analyst P-wave', color=\"tab:red\")\n        if s_val_max == 1:\n            axs[1].plot(targets[-1][\"max_idx\"], sample[\"y\"][1][targets[-1][\"max_idx\"]], 'o', label='Analyst S-wave', color='tab:blue')\n        axs[1].plot(p_pred,label='P-wave Prediction', color=\"tab:red\", linestyle='-.')\n        axs[1].plot(s_pred,label='S-wave Predition', color='tab:blue', linestyle='-.')\n        if largest_ppeak_idx > 0:\n            axs[1].plot(predictions[-2][\"pred_max_idx\"],p_pred[predictions[-2][\"pred_max_idx\"]], 'D', label='Predicted P-wave', color=\"tab:red\")\n        if largest_speak_idx > 0:\n            axs[1].plot(predictions[-1][\"pred_max_idx\"],s_pred[predictions[-1][\"pred_max_idx\"]], 'D', label='Predicted S-wave', color=\"tab:blue\")\n        axs[1].set_xlabel('Time (s)',fontsize=14)\n        axs[1].set_ylabel('Target Amplitude',fontsize=14)\n        axs[0].set_ylabel('Amplitude',fontsize=14)\n        # axs[1].plot(noise_pred,label='Noise Prediction', color=\"tab:green\", linestyle='-.')\n        axs[1].legend()\n        axs[0].legend()\n        axs[0].set_xlim((0,3000))\n        axs[1].set_xlim((0,3000))\n        axs[0].set_title(f\"Trace ID: {ii}\", fontsize=16)\n\ntargets = pd.DataFrame(targets)\npredictions = pd.DataFrame(predictions)","key":"Jve9X2LGl2"},{"type":"outputs","id":"OMWmIMM3wAS4XsGuJUMgY","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"/Users/amt/anaconda3/envs/pytorch/lib/python3.12/site-packages/seisbench/models/base.py:489: FutureWarning: You are using `torch.load` with `weights_only=False` (the current default value), which uses the default pickle module implicitly. It is possible to construct malicious pickle data which will execute arbitrary code during unpickling (See https://github.com/pytorch/pytorch/blob/main/SECURITY.md#untrusted-models for more details). In a future release, the default value for `weights_only` will be flipped to `True`. This limits the functions that could be executed during unpickling. Arbitrary objects will no longer be allowed to be loaded via this mode unless they are explicitly allowlisted by the user via `torch.serialization.add_safe_globals`. We recommend you start setting `weights_only=True` for any use case where you don't have full control of the loaded file. Please open an issue on GitHub for any issues related to this experimental feature.\n  model_weights = torch.load(f\"{path_pt}\")\n"},"children":[],"key":"zKOmiXANll"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"a91ff7ab2e33784944b6ba54059c71c1","path":"/a91ff7ab2e33784944b6ba54059c71c1.png"},"text/plain":{"content":"<Figure size 1500x1000 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"ujAlrtePp7"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"e27e88c6109fd1109de1c441d57dd4f3","path":"/e27e88c6109fd1109de1c441d57dd4f3.png"},"text/plain":{"content":"<Figure size 1500x1000 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"bHIweHTeNz"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"ec65db7fb412e5924811e89a822db323","path":"/ec65db7fb412e5924811e89a822db323.png"},"text/plain":{"content":"<Figure size 1500x1000 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"HFS6LzrVb0"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"16bccc820e6094834e68c9ad2be9afbc","path":"/16bccc820e6094834e68c9ad2be9afbc.png"},"text/plain":{"content":"<Figure size 1500x1000 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"mDF45Veh3p"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"b4cbea21f5e12ed8ccf9ab4bee2c6723","path":"/b4cbea21f5e12ed8ccf9ab4bee2c6723.png"},"text/plain":{"content":"<Figure size 1500x1000 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"bWHkWHw3oQ"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"84ed9aa61875e89266831a0d62906d47","path":"/84ed9aa61875e89266831a0d62906d47.png"},"text/plain":{"content":"<Figure size 1500x1000 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"fnEE2Vjvyr"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"36c7fa9b9a817e4b44a2076c6731af20","path":"/36c7fa9b9a817e4b44a2076c6731af20.png"},"text/plain":{"content":"<Figure size 1500x1000 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"tqePnIXreh"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"ef78fd42a683411eb512c48ff1199086","path":"/ef78fd42a683411eb512c48ff1199086.png"},"text/plain":{"content":"<Figure size 1500x1000 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"uJ4b9uZSmt"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"0fc92194a0183b69130b4c5c9ba4ef41","path":"/0fc92194a0183b69130b4c5c9ba4ef41.png"},"text/plain":{"content":"<Figure size 1500x1000 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"UDmBDniNqM"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"037a418672764d9ffa5a565393419e00","path":"/037a418672764d9ffa5a565393419e00.png"},"text/plain":{"content":"<Figure size 1500x1000 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"fmd9NVYl3n"}],"key":"WFukGRvNgl"}],"key":"yKJLUaUDvh"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"targets","key":"n4MuiDdLhZ"},{"type":"outputs","id":"xOGYRN62PaeEP_s6XjAoC","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":12,"metadata":{},"data":{"text/html":{"content":"<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>trace_id</th>\n      <th>max_idx</th>\n      <th>phase</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>0</td>\n      <td>1870.0</td>\n      <td>P</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>0</td>\n      <td>2890.0</td>\n      <td>S</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>1</td>\n      <td>1362.0</td>\n      <td>P</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>1</td>\n      <td>2286.0</td>\n      <td>S</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>2</td>\n      <td>1762.0</td>\n      <td>P</td>\n    </tr>\n    <tr>\n      <th>...</th>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n    </tr>\n    <tr>\n      <th>17935</th>\n      <td>8967</td>\n      <td>2031.0</td>\n      <td>S</td>\n    </tr>\n    <tr>\n      <th>17936</th>\n      <td>8968</td>\n      <td>809.0</td>\n      <td>P</td>\n    </tr>\n    <tr>\n      <th>17937</th>\n      <td>8968</td>\n      <td>1738.0</td>\n      <td>S</td>\n    </tr>\n    <tr>\n      <th>17938</th>\n      <td>8969</td>\n      <td>1506.0</td>\n      <td>P</td>\n    </tr>\n    <tr>\n      <th>17939</th>\n      <td>8969</td>\n      <td>2310.0</td>\n      <td>S</td>\n    </tr>\n  </tbody>\n</table>\n<p>17940 rows × 3 columns</p>\n</div>","content_type":"text/html"},"text/plain":{"content":"       trace_id  max_idx phase\n0             0   1870.0     P\n1             0   2890.0     S\n2             1   1362.0     P\n3             1   2286.0     S\n4             2   1762.0     P\n...         ...      ...   ...\n17935      8967   2031.0     S\n17936      8968    809.0     P\n17937      8968   1738.0     S\n17938      8969   1506.0     P\n17939      8969   2310.0     S\n\n[17940 rows x 3 columns]","content_type":"text/plain"}}},"children":[],"key":"zZX6bMpK4O"}],"key":"EtticYeEmr"}],"key":"lh64Bxeren"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"predictions","key":"uTA18Dd4VD"},{"type":"outputs","id":"F1oRwzy5HZZK56gyq2xxl","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":13,"metadata":{},"data":{"text/html":{"content":"<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>trace_id</th>\n      <th>pred_max_idx</th>\n      <th>pred_val</th>\n      <th>phase</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>0</td>\n      <td>1873.0</td>\n      <td>0.436259</td>\n      <td>P</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>0</td>\n      <td>NaN</td>\n      <td>NaN</td>\n      <td>S</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>1</td>\n      <td>1361.0</td>\n      <td>0.791852</td>\n      <td>P</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>1</td>\n      <td>2282.0</td>\n      <td>0.720918</td>\n      <td>S</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>2</td>\n      <td>1764.0</td>\n      <td>0.932841</td>\n      <td>P</td>\n    </tr>\n    <tr>\n      <th>...</th>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n    </tr>\n    <tr>\n      <th>17935</th>\n      <td>8967</td>\n      <td>2038.0</td>\n      <td>0.472659</td>\n      <td>S</td>\n    </tr>\n    <tr>\n      <th>17936</th>\n      <td>8968</td>\n      <td>813.0</td>\n      <td>0.908409</td>\n      <td>P</td>\n    </tr>\n    <tr>\n      <th>17937</th>\n      <td>8968</td>\n      <td>1738.0</td>\n      <td>0.755865</td>\n      <td>S</td>\n    </tr>\n    <tr>\n      <th>17938</th>\n      <td>8969</td>\n      <td>1511.0</td>\n      <td>0.946008</td>\n      <td>P</td>\n    </tr>\n    <tr>\n      <th>17939</th>\n      <td>8969</td>\n      <td>2293.0</td>\n      <td>0.575749</td>\n      <td>S</td>\n    </tr>\n  </tbody>\n</table>\n<p>17940 rows × 4 columns</p>\n</div>","content_type":"text/html"},"text/plain":{"content":"       trace_id  pred_max_idx  pred_val phase\n0             0        1873.0  0.436259     P\n1             0           NaN       NaN     S\n2             1        1361.0  0.791852     P\n3             1        2282.0  0.720918     S\n4             2        1764.0  0.932841     P\n...         ...           ...       ...   ...\n17935      8967        2038.0  0.472659     S\n17936      8968         813.0  0.908409     P\n17937      8968        1738.0  0.755865     S\n17938      8969        1511.0  0.946008     P\n17939      8969        2293.0  0.575749     S\n\n[17940 rows x 4 columns]","content_type":"text/plain"}}},"children":[],"key":"hrtd3fxw6a"}],"key":"qPZWalOqPG"}],"key":"JZ45XjZpyK"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"5.  Common Performance Metrics","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kyZTdQQNzZ"}],"identifier":"id-5-common-performance-metrics","label":"5.  Common Performance Metrics","html_id":"id-5-common-performance-metrics","implicit":true,"key":"Elx4lV4PF4"},{"type":"heading","depth":3,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The Confusion Matrix","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"GjyPxHOtUW"}],"identifier":"the-confusion-matrix","label":"The Confusion Matrix","html_id":"the-confusion-matrix","implicit":true,"key":"wsaK394uZI"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"The confusion matrix is a tool used to evaluate the performance of a model. It provides insight into the model’s performance, errors, and weaknesses which will allow us to further improve our model through fine-tuning.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"KgPVYSxRXm"}],"key":"s2rIUvDL7R"},{"type":"image","url":"/92e2551add9c1d800cc2a7a5df7dd35c.png","width":800,"key":"A6xDjyXoT1","urlSource":"https://github.com/amtseismo/2025_ML_TSC/blob/main/notebooks/Amanda/confusion_matrix.png?raw=true"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"The four categories in the confusion matrix are:","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"x4ecpdKdKG"}],"key":"f0TlVtAr01"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":11,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"True positive (TP)","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"Uev9Dv6EMY"}],"key":"KN1T8JubZT"},{"type":"text","value":" - The model correctly (true) predicts the positive class (positive).","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"mIsmfRjyK8"}],"key":"JBdnT5XUoq"}],"key":"blDQ3koYo2"},{"type":"listItem","spread":true,"position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"False positive (FP)","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"A0tyEVIQJM"}],"key":"pBoqIW1L4w"},{"type":"text","value":" - The model incorrectly (false) predicts the positive class (positive).","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"SpfNj1C9Ue"}],"key":"kLDbUlrTmD"}],"key":"bG7sYlTH7Y"},{"type":"listItem","spread":true,"position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"False negative (FN)","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"TjajuMeB2G"}],"key":"jT8HqL51B4"},{"type":"text","value":" - The model incorrectly (false) predicts the negative class (negative).","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"IhQlkb1RtV"}],"key":"jTFapp7M8d"}],"key":"xjvzfPkywm"},{"type":"listItem","spread":true,"position":{"start":{"line":14,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"True negative (TN)","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"QXIXH1OzRE"}],"key":"u0ru0h1wfP"},{"type":"text","value":" - The model correctly (true) predicts the negative class (negative).","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"RtwVjMpqLk"}],"key":"dCFwOYKcVc"}],"key":"Oa8r82kcAC"}],"key":"EfvjL8zo5e"},{"type":"paragraph","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"Using these categories, there are multiple different metrics one can use to assess network perfomance.  For demonstration purposes, lets say we have a dataset of 100 seismograms.  5 of them contain earthquakes, and 95 of them contain noise.  Lets also say of the 5 earthquakes, the model correctly predicts 4 of them and misses 1.  For the 95 noise samples, the model correctly predicts 90 of them as noise and the other 5 it calls earthquakes.  In this scenario, TP = 4, TN = 90, FP = 5, FN = 1.","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"uBRuzAnAmq"}],"key":"jFBDniRCoW"},{"type":"heading","depth":3,"position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"Accuracy","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"TRBZVDgObK"}],"identifier":"accuracy","label":"Accuracy","html_id":"accuracy","implicit":true,"key":"qB9OtH7B8E"},{"type":"paragraph","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"text","value":"Accuracy shows how often a model is correct overall.  It is defined as the total number of true predictions (i.e. TP + TN) divided by the total number of predictions.","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"Hyl6OXTtiP"}],"key":"kpYGPR8wu9"},{"type":"paragraph","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"inlineMath","value":"\\huge Accuracy = \\frac{TP + TN}{TP + FP + FN + TN} ","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mstyle mathsize=\"2.074em\"><mi>A</mi><mi>c</mi><mi>c</mi><mi>u</mi><mi>r</mi><mi>a</mi><mi>c</mi><mi>y</mi><mo>=</mo><mfrac><mrow><mi>T</mi><mi>P</mi><mo>+</mo><mi>T</mi><mi>N</mi></mrow><mrow><mi>T</mi><mi>P</mi><mo>+</mo><mi>F</mi><mi>P</mi><mo>+</mo><mi>F</mi><mi>N</mi><mo>+</mo><mi>T</mi><mi>N</mi></mrow></mfrac></mstyle></mrow><annotation encoding=\"application/x-tex\">\\huge Accuracy = \\frac{TP + TN}{TP + FP + FN + TN} </annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.8205em;vertical-align:-0.4033em;\"></span><span class=\"mord mathnormal sizing reset-size6 size10\">A</span><span class=\"mord mathnormal sizing reset-size6 size10\">cc</span><span class=\"mord mathnormal sizing reset-size6 size10\">u</span><span class=\"mord mathnormal sizing reset-size6 size10\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal sizing reset-size6 size10\">a</span><span class=\"mord mathnormal sizing reset-size6 size10\" style=\"margin-right:0.03588em;\">cy</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel sizing reset-size6 size10\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.6367em;vertical-align:-0.8355em;\"></span><span class=\"mord sizing reset-size6 size10\"><span class=\"mopen nulldelimiter sizing reset-size10 size6\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8684em;\"><span style=\"top:-3.095em;\"><span class=\"pstrut\" style=\"height:3.44em;\"></span><span class=\"sizing reset-size10 size8 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">TP</span><span class=\"mbin mtight\">+</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">FP</span><span class=\"mbin mtight\">+</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">FN</span><span class=\"mbin mtight\">+</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">TN</span></span></span></span><span style=\"top:-3.67em;\"><span class=\"pstrut\" style=\"height:3.44em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.834em;\"><span class=\"pstrut\" style=\"height:3.44em;\"></span><span class=\"sizing reset-size10 size8 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">TP</span><span class=\"mbin mtight\">+</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">TN</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.4029em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter sizing reset-size10 size6\"></span></span></span></span></span>","key":"FjIV6DjAuY"}],"key":"U2yUQhvUe6"},{"type":"paragraph","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"text","value":"In our example above, TP + TN = 94 and the total number of predictions is 100 so we have 94% accuracy overall -- woo hoo!","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"wW9NUzJjpA"}],"key":"KVFpQiiuL7"},{"type":"paragraph","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"children":[{"type":"text","value":"Accuracy is widely used but its not always useful because it treats all classes as equally important. If a dataset is well balanced, meaning it has equal or nearly equal representation in the training data of all classes, accuracy can be a helpful metric. However, many real-world applications have a high imbalance of classes. These are the cases when one category has significantly more frequent occurrences than the other. In seismology, this would happen if you were to just estimate whether each section of a seismogram had an earthquake or recorded only noise. In scenarios like this, you are typically interested in predicting the events that rarely occur (i.e. earthquakes). It is easy to “game” the accuracy metric when making predictions for a dataset like this. To do that, you simply need to predict that every waveform is noise.  If only 5 in 100 waveforms actually contain an earthquake, a model predicting noise all the time will mostly be right, leading to very high accuracy.  In this particular situaion, your model would be 95% accurate however you’d miss every earthquake -- so high accuracy models can be useless. Overall accuracy is informative but using this metric alone is not advisable.","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"Ybio3I6nZ6"}],"key":"DVdEbrBGzC"},{"type":"heading","depth":3,"position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"children":[{"type":"text","value":"Precision","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"RYMZS9Kviq"}],"identifier":"precision","label":"Precision","html_id":"precision","implicit":true,"key":"Q4zEbmkxTr"},{"type":"paragraph","position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"children":[{"type":"text","value":"Precision is a metric that measures how often a machine learning model is correct when it predicts the positive class (in our case, earthquakes). You can calculate precision by dividing the number of true positive predictions (TPs) by the total number of instances the model predicted as positive (TP + FP).","position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"key":"EYwiUaBgXv"}],"key":"AuXelAfL0o"},{"type":"paragraph","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"children":[{"type":"inlineMath","value":"\\huge Precision = \\frac{TP}{TP + FP} ","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mstyle mathsize=\"2.074em\"><mi>P</mi><mi>r</mi><mi>e</mi><mi>c</mi><mi>i</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mfrac><mrow><mi>T</mi><mi>P</mi></mrow><mrow><mi>T</mi><mi>P</mi><mo>+</mo><mi>F</mi><mi>P</mi></mrow></mfrac></mstyle></mrow><annotation encoding=\"application/x-tex\">\\huge Precision = \\frac{TP}{TP + FP} </annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.4172em;\"></span><span class=\"mord mathnormal sizing reset-size6 size10\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathnormal sizing reset-size6 size10\">rec</span><span class=\"mord mathnormal sizing reset-size6 size10\">i</span><span class=\"mord mathnormal sizing reset-size6 size10\">s</span><span class=\"mord mathnormal sizing reset-size6 size10\">i</span><span class=\"mord mathnormal sizing reset-size6 size10\">o</span><span class=\"mord mathnormal sizing reset-size6 size10\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel sizing reset-size6 size10\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.6367em;vertical-align:-0.8355em;\"></span><span class=\"mord sizing reset-size6 size10\"><span class=\"mopen nulldelimiter sizing reset-size10 size6\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8684em;\"><span style=\"top:-3.095em;\"><span class=\"pstrut\" style=\"height:3.44em;\"></span><span class=\"sizing reset-size10 size8 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">TP</span><span class=\"mbin mtight\">+</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">FP</span></span></span></span><span style=\"top:-3.67em;\"><span class=\"pstrut\" style=\"height:3.44em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.834em;\"><span class=\"pstrut\" style=\"height:3.44em;\"></span><span class=\"sizing reset-size10 size8 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">TP</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.4029em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter sizing reset-size10 size6\"></span></span></span></span></span>","key":"qSecPdQpWG"}],"key":"GZpOhRwjpc"},{"type":"paragraph","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"children":[{"type":"text","value":"In our example above, TP = 4 and FP = 5 so the precition is 4/9 or 44%.","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"fCzUeWxMoX"}],"key":"C7G0196HwN"},{"type":"paragraph","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"children":[{"type":"text","value":"Precision works well for problems with imbalanced classes since it shows the model correctness in identifying the positive class.  It’s important to note that precision does not consider false negatives meaning it does not account for the cases when we miss earthquakes.","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"CtAazRRE85"}],"key":"R5qBrIOMmi"},{"type":"heading","depth":3,"position":{"start":{"line":38,"column":1},"end":{"line":38,"column":1}},"children":[{"type":"text","value":"Recall","position":{"start":{"line":38,"column":1},"end":{"line":38,"column":1}},"key":"jVwrtoPNjA"}],"identifier":"recall","label":"Recall","html_id":"recall","implicit":true,"key":"onD8crayYn"},{"type":"paragraph","position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"children":[{"type":"text","value":"Recall is a metric that measures how often a machine learning model correctly identifies positive instances (TP) from all the actual positive samples in the dataset (TP + FN).","position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"key":"F34Uy7KSmc"}],"key":"dYu9ng7Hux"},{"type":"paragraph","position":{"start":{"line":42,"column":1},"end":{"line":42,"column":1}},"children":[{"type":"inlineMath","value":"\\huge Recall = \\frac{TP}{TP + FN} ","position":{"start":{"line":42,"column":1},"end":{"line":42,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mstyle mathsize=\"2.074em\"><mi>R</mi><mi>e</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mo>=</mo><mfrac><mrow><mi>T</mi><mi>P</mi></mrow><mrow><mi>T</mi><mi>P</mi><mo>+</mo><mi>F</mi><mi>N</mi></mrow></mfrac></mstyle></mrow><annotation encoding=\"application/x-tex\">\\huge Recall = \\frac{TP}{TP + FN} </annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.4403em;\"></span><span class=\"mord mathnormal sizing reset-size6 size10\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal sizing reset-size6 size10\">ec</span><span class=\"mord mathnormal sizing reset-size6 size10\">a</span><span class=\"mord mathnormal sizing reset-size6 size10\" style=\"margin-right:0.01968em;\">ll</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel sizing reset-size6 size10\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.6367em;vertical-align:-0.8355em;\"></span><span class=\"mord sizing reset-size6 size10\"><span class=\"mopen nulldelimiter sizing reset-size10 size6\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8684em;\"><span style=\"top:-3.095em;\"><span class=\"pstrut\" style=\"height:3.44em;\"></span><span class=\"sizing reset-size10 size8 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">TP</span><span class=\"mbin mtight\">+</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">FN</span></span></span></span><span style=\"top:-3.67em;\"><span class=\"pstrut\" style=\"height:3.44em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.834em;\"><span class=\"pstrut\" style=\"height:3.44em;\"></span><span class=\"sizing reset-size10 size8 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">TP</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.4029em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter sizing reset-size10 size6\"></span></span></span></span></span>","key":"PYqAYKoONe"}],"key":"hNuwq2uO7u"},{"type":"paragraph","position":{"start":{"line":44,"column":1},"end":{"line":44,"column":1}},"children":[{"type":"text","value":"From our example above, TP = 4 and FN = 1, so our recall is 4/5 or 80%.","position":{"start":{"line":44,"column":1},"end":{"line":44,"column":1}},"key":"O19Tv2QgZJ"}],"key":"dAcZ1X0CJ7"},{"type":"paragraph","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"children":[{"type":"text","value":"Recall works well for problems with imbalanced classes since it is focused on the model’s ability to find earthquakes.  Recall is useful when the cost of false negatives is high. In this case, you typically want to find all earthquakes, even if this results in some false positives (predicting an earthquake when it is actually noise).  A downside is that recall does not account for the cost of these false positives.","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"key":"OzuOSr7cyp"}],"key":"T5pFWztSyJ"},{"type":"heading","depth":3,"position":{"start":{"line":48,"column":1},"end":{"line":48,"column":1}},"children":[{"type":"text","value":"F1 score","position":{"start":{"line":48,"column":1},"end":{"line":48,"column":1}},"key":"lDUQJi8glx"}],"identifier":"f1-score","label":"F1 score","html_id":"f1-score","implicit":true,"key":"jFRAihB1z9"},{"type":"paragraph","position":{"start":{"line":50,"column":1},"end":{"line":50,"column":1}},"children":[{"type":"text","value":"If precision is high but recall is low, it means you’re cautious and only pick when confident — but miss many real picks.  If recall is high but precision is low, it means you’re aggressive, finding most real picks — but also making lots of false ones.  The F1 score is a metric that combines precision and recall into a single number. It’s especially useful when you want a balance between these two, particularly in imbalanced datasets — like seismic phase picking, where picks are rare compared to the number of time steps.","position":{"start":{"line":50,"column":1},"end":{"line":50,"column":1}},"key":"t6J4OZUxXG"}],"key":"VWCjv6JJmA"},{"type":"paragraph","position":{"start":{"line":52,"column":1},"end":{"line":52,"column":1}},"children":[{"type":"inlineMath","value":"\\huge F1 = \\frac{2*precision*recall}{precision + recall}","position":{"start":{"line":52,"column":1},"end":{"line":52,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mstyle mathsize=\"2.074em\"><mi>F</mi><mn>1</mn><mo>=</mo><mfrac><mrow><mn>2</mn><mo>∗</mo><mi>p</mi><mi>r</mi><mi>e</mi><mi>c</mi><mi>i</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>∗</mo><mi>r</mi><mi>e</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi></mrow><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>c</mi><mi>i</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>+</mo><mi>r</mi><mi>e</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi></mrow></mfrac></mstyle></mrow><annotation encoding=\"application/x-tex\">\\huge F1 = \\frac{2*precision*recall}{precision + recall}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.4172em;\"></span><span class=\"mord mathnormal sizing reset-size6 size10\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord sizing reset-size6 size10\">1</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel sizing reset-size6 size10\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.9185em;vertical-align:-0.9955em;\"></span><span class=\"mord sizing reset-size6 size10\"><span class=\"mopen nulldelimiter sizing reset-size10 size6\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9272em;\"><span style=\"top:-3.095em;\"><span class=\"pstrut\" style=\"height:3.44em;\"></span><span class=\"sizing reset-size10 size8 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\">rec</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">n</span><span class=\"mbin mtight\">+</span><span class=\"mord mathnormal mtight\">rec</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">ll</span></span></span></span><span style=\"top:-3.67em;\"><span class=\"pstrut\" style=\"height:3.44em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.885em;\"><span class=\"pstrut\" style=\"height:3.44em;\"></span><span class=\"sizing reset-size10 size8 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span><span class=\"mbin mtight\">∗</span><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\">rec</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">n</span><span class=\"mbin mtight\">∗</span><span class=\"mord mathnormal mtight\">rec</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">ll</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.48em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter sizing reset-size10 size6\"></span></span></span></span></span>","key":"pLaMZ0VQjN"}],"key":"Gl174Y2eFN"},{"type":"paragraph","position":{"start":{"line":54,"column":1},"end":{"line":54,"column":1}},"children":[{"type":"text","value":"F1 gives a harmonic mean, so it heavily penalizes large gaps between precision and recall.","position":{"start":{"line":54,"column":1},"end":{"line":54,"column":1}},"key":"ETNfTMndbW"}],"key":"Ph44cizfOA"}],"key":"l4b3VsOqhD"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"6. Compute UNet Performance metrics","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YdPvBO4HLX"}],"identifier":"id-6-compute-unet-performance-metrics","label":"6. Compute UNet Performance metrics","html_id":"id-6-compute-unet-performance-metrics","implicit":true,"key":"TWLw67MkSZ"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Looking back at the original Zhu and Beroza [2019] paper that introduced PhaseNet, they have a little bit of a problem.  They’ve set up the earthquake detection problem as a regression where the network outputs a “probability” between 0 and 1 to identify noise (0) vs. a phase arrival (1).  So how do we translate this into a classicifcation problem so that we can use the swanky metrics we introduced above?  Well they did it as follows (and so will we!):","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"IB1SmvtK4H"}],"key":"O46caVg1d8"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"True positive","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"zZQDEyyVJf"}],"key":"nZBa7LdQLW"},{"type":"text","value":" - peak amplitude is above decision threshold and < 0.1s from true arrival","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"K5KIrBwvLo"}],"key":"dumsFjXJbh"}],"key":"OT3no5Z5Jx"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"False positive","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"v5Ttk6pHoV"}],"key":"I6rNScSbl0"},{"type":"text","value":" - peak amplitude is above decision threshold and >= 0.1s from true arrival","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"Cqaf5Tf0Xi"}],"key":"zmIJJcMTP8"}],"key":"va4m3ZhKTL"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"False negative","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"ScGNRIbELL"}],"key":"iFwGVsu0qj"},{"type":"text","value":" - peak amplitude is below decision threshold and < 0.1s from true arrival","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"TT9IfBK9zP"}],"key":"quRDiEsbvd"}],"key":"fgPZEaH7tC"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"True negative","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"zNPuISJdas"}],"key":"RQ1pFZeKYP"},{"type":"text","value":" - peak amplitude is below decision threshold and >= 0.1s","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"owBTIWnIIL"}],"key":"fBm7GJLi0Q"}],"key":"KZrdgtH6NP"}],"key":"KTiAd0Y9Rm"}],"key":"KsSIs0gwvT"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"This next block includes masks that deal with missing targets or predictions.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tEI4CA5FkJ"}],"key":"RVkjgdmt68"}],"key":"qcONs1LnjM"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"merged = pd.merge(\n    predictions, \n    targets, \n    how=\"inner\", \n    on=[\"trace_id\", \"phase\"],\n    suffixes=('_pred', '_true')\n)\n\n# Delete for speed\ndel predictions\ndel targets\n\n# Dealing with the NaNs\nmask=False\nif mask:\n    no_pred_and_no_target = (\n        merged[\"pred_max_idx\"].isna() & \n        merged[\"max_idx\"].isna() & \n        merged[\"pred_val\"].isna()\n    )\n\n    target_no_pred = (\n        merged[\"pred_max_idx\"].isna() & \n        merged[\"max_idx\"].notna() & \n        merged[\"pred_val\"].isna()\n    )\n\n    pred_no_target = (\n        merged[\"pred_max_idx\"].notna() & \n        merged[\"max_idx\"].isna() & \n        merged[\"pred_val\"].notna()\n    )\n\n    # Apply masks\n    merged.loc[no_pred_and_no_target, [\"pred_max_idx\", \"max_idx\", \"pred_val\"]] = [0, 100, 0]\n    merged.loc[target_no_pred, [\"pred_max_idx\", \"max_idx\", \"pred_val\"]] = [0, 0, 0]\n    merged.loc[pred_no_target, [\"pred_max_idx\", \"max_idx\"]] = [0, 100]\nelse:\n    merged=merged.dropna()\n\nwith pd.option_context('display.max_rows', None, 'display.max_columns', None):\n    print(merged)\n\n# Check for NaN values in the merged DataFrame\nmerged[merged.isna().any(axis=1)]","key":"ChxH9nWnAC"},{"type":"outputs","id":"NA3kRnh9db8FMBBRS5xnj","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"       trace_id  pred_max_idx  pred_val phase  max_idx\n0     ...","hash":"280c1f9cc7c42b28d2abaa7bdeb704c8","path":"/280c1f9cc7c42b28d2abaa7bdeb704c8.txt"},"children":[],"key":"hegTvoRK33"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":14,"metadata":{},"data":{"text/html":{"content":"<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>trace_id</th>\n      <th>pred_max_idx</th>\n      <th>pred_val</th>\n      <th>phase</th>\n      <th>max_idx</th>\n    </tr>\n  </thead>\n  <tbody>\n  </tbody>\n</table>\n</div>","content_type":"text/html"},"text/plain":{"content":"Empty DataFrame\nColumns: [trace_id, pred_max_idx, pred_val, phase, max_idx]\nIndex: []","content_type":"text/plain"}}},"children":[],"key":"iZcOhMBK7f"}],"key":"ygOcoCx9am"}],"key":"wb1wsuFmvx"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"decision_thresholds = np.linspace(0.05, 0.95, num=19)\npprecision = np.zeros(len(decision_thresholds))\nprecall = np.zeros(len(decision_thresholds))\nsprecision = np.zeros(len(decision_thresholds))\nsrecall = np.zeros(len(decision_thresholds))\n\nfor phase in [\"P\", \"S\"]:\n    phase_data = merged[merged[\"phase\"] == phase]\n    for ii, decision_threshold in enumerate(decision_thresholds):\n        above_thresh = phase_data[\"pred_val\"] >= decision_threshold\n        close_enough = (phase_data[\"pred_max_idx\"] - phase_data[\"max_idx\"]).abs() < 10\n\n        TP = ((above_thresh) & (close_enough)).sum()\n        FP = ((above_thresh) & (~close_enough)).sum()\n        FN = ((~above_thresh) & (close_enough)).sum()\n        TN = ((~above_thresh) & (~close_enough)).sum()\n\n        # Save or print results here as before  \n        print(f\"Decision Threshold: {decision_threshold}, TP: {TP}, FP: {FP}, FN: {FN}, TN: {TN}, Total: {TN+FN+TP+FP}\")\n\n        if phase == \"P\":\n            pprecision[ii] = TP / (TP + FP) if (TP + FP) > 0 else 0\n            precall[ii] = TP / (TP + FN) if (TP + FN) > 0 else 0\n        elif phase == \"S\":\n            sprecision[ii] = TP / (TP + FP) if (TP + FP) > 0 else 0\n            srecall[ii] = TP / (TP + FN) if (TP + FN) > 0 else 0\n\npF1=2*pprecision*precall/(pprecision+precall)\nsF1=2*sprecision*srecall/(sprecision+srecall)","key":"J4ozhFBIoR"},{"type":"outputs","id":"ENcygAFWNtackism6FvcV","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Decision Threshold: 0.05, TP: 5116, FP: 710, FN: 0, TN: 0, Total: 5826\nDecision Threshold: 0.1, TP: 4940, FP: 638, FN: 176, TN: 72, Total: 5826\nDecision Threshold: 0.15, TP: 4795, FP: 585, FN: 321, TN: 125, Total: 5826\nDecision Threshold: 0.2, TP: 4642, FP: 542, FN: 474, TN: 168, Total: 5826\nDecision Threshold: 0.25, TP: 4510, FP: 499, FN: 606, TN: 211, Total: 5826\nDecision Threshold: 0.3, TP: 4366, FP: 471, FN: 750, TN: 239, Total: 5826\nDecision Threshold: 0.35, TP: 4241, FP: 439, FN: 875, TN: 271, Total: 5826\nDecision Threshold: 0.39999999999999997, TP: 4087, FP: 406, FN: 1029, TN: 304, Total: 5826\nDecision Threshold: 0.44999999999999996, TP: 3885, FP: 376, FN: 1231, TN: 334, Total: 5826\nDecision Threshold: 0.49999999999999994, TP: 3529, FP: 348, FN: 1587, TN: 362, Total: 5826\nDecision Threshold: 0.5499999999999999, TP: 3316, FP: 327, FN: 1800, TN: 383, Total: 5826\nDecision Threshold: 0.6, TP: 3139, FP: 302, FN: 1977, TN: 408, Total: 5826\nDecision Threshold: 0.65, TP: 2989, FP: 278, FN: 2127, TN: 432, Total: 5826\nDecision Threshold: 0.7, TP: 2854, FP: 245, FN: 2262, TN: 465, Total: 5826\nDecision Threshold: 0.75, TP: 2708, FP: 210, FN: 2408, TN: 500, Total: 5826\nDecision Threshold: 0.7999999999999999, TP: 2498, FP: 174, FN: 2618, TN: 536, Total: 5826\nDecision Threshold: 0.85, TP: 2185, FP: 113, FN: 2931, TN: 597, Total: 5826\nDecision Threshold: 0.9, TP: 1790, FP: 70, FN: 3326, TN: 640, Total: 5826\nDecision Threshold: 0.95, TP: 941, FP: 20, FN: 4175, TN: 690, Total: 5826\nDecision Threshold: 0.05, TP: 4828, FP: 1006, FN: 0, TN: 0, Total: 5834\nDecision Threshold: 0.1, TP: 4600, FP: 891, FN: 228, TN: 115, Total: 5834\nDecision Threshold: 0.15, TP: 4386, FP: 824, FN: 442, TN: 182, Total: 5834\nDecision Threshold: 0.2, TP: 4193, FP: 767, FN: 635, TN: 239, Total: 5834\nDecision Threshold: 0.25, TP: 3985, FP: 721, FN: 843, TN: 285, Total: 5834\nDecision Threshold: 0.3, TP: 3785, FP: 654, FN: 1043, TN: 352, Total: 5834\nDecision Threshold: 0.35, TP: 3543, FP: 595, FN: 1285, TN: 411, Total: 5834\nDecision Threshold: 0.39999999999999997, TP: 3299, FP: 541, FN: 1529, TN: 465, Total: 5834\nDecision Threshold: 0.44999999999999996, TP: 3021, FP: 499, FN: 1807, TN: 507, Total: 5834\nDecision Threshold: 0.49999999999999994, TP: 2765, FP: 431, FN: 2063, TN: 575, Total: 5834\nDecision Threshold: 0.5499999999999999, TP: 2534, FP: 370, FN: 2294, TN: 636, Total: 5834\nDecision Threshold: 0.6, TP: 2272, FP: 330, FN: 2556, TN: 676, Total: 5834\nDecision Threshold: 0.65, TP: 2022, FP: 278, FN: 2806, TN: 728, Total: 5834\nDecision Threshold: 0.7, TP: 1772, FP: 215, FN: 3056, TN: 791, Total: 5834\nDecision Threshold: 0.75, TP: 1475, FP: 156, FN: 3353, TN: 850, Total: 5834\nDecision Threshold: 0.7999999999999999, TP: 1156, FP: 110, FN: 3672, TN: 896, Total: 5834\nDecision Threshold: 0.85, TP: 802, FP: 55, FN: 4026, TN: 951, Total: 5834\nDecision Threshold: 0.9, TP: 417, FP: 18, FN: 4411, TN: 988, Total: 5834\nDecision Threshold: 0.95, TP: 79, FP: 3, FN: 4749, TN: 1003, Total: 5834\n"},"children":[],"key":"WyDTbTOpgT"}],"key":"dvjoVfC8tu"}],"key":"sgVnmtt4Xs"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"7. Plot precision, recall, and F1","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BxmigFTwQ2"}],"identifier":"id-7-plot-precision-recall-and-f1","label":"7. Plot precision, recall, and F1","html_id":"id-7-plot-precision-recall-and-f1","implicit":true,"key":"hQGe9GUrq1"}],"key":"O9qGfElqkI"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"fig = plt.figure()\nfig, axs = plt.subplots(\n    1, 2,              # 1 row, 2 columns\n    figsize=(15, 6),  # overall figure size\n    sharey=True,       # share y-axis\n    gridspec_kw={\"width_ratios\": [1, 1], \"wspace\": 0.1}  # control layout\n)\ndecision_thresholds = np.linspace(0.05, 0.95, num=19)\naxs[0].plot(decision_thresholds, pprecision, label='P Precision', color=\"tab:red\")\naxs[0].plot(decision_thresholds, precall, label='P Recall', color=\"tab:blue\")\naxs[0].plot(decision_thresholds, pF1, label='P F1', color=\"tab:green\")\naxs[0].set_xlim(0,1)\naxs[0].set_ylim(0,1)\naxs[0].legend()\naxs[0].set_title(\"P-wave\", fontsize=14)\naxs[1].set_title(\"S-wave\", fontsize=14)\naxs[1].plot(decision_thresholds, sprecision, label='S Precision', color=\"tab:red\")\naxs[1].plot(decision_thresholds, srecall, label='S Recall', color=\"tab:blue\")\naxs[1].plot(decision_thresholds, sF1, label='S F1', color=\"tab:green\")\naxs[1].set_xlim(0,1)\naxs[1].set_ylim(0,1)\naxs[0].set_xlabel('Decision Threshold', fontsize=14)\naxs[1].set_xlabel('Decision Threshold', fontsize=14)\naxs[1].legend()\n\nind=9\nprint(\"P Precision = \"+str(pprecision[ind]))\nprint(\"P Recall = \"+str(precall[ind]))\nprint(\"S Precision = \"+str(sprecision[ind]))\nprint(\"S Recall = \"+str(srecall[ind]))","key":"RGPJF029pK"},{"type":"outputs","id":"at7qX5qUbkzc9RkdqTX8n","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"P Precision = 0.9102398761929327\nP Recall = 0.6897967161845192\nS Precision = 0.8651439299123905\nS Recall = 0.5727009113504556\n"},"children":[],"key":"Dy3F0p6Qz1"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"text/plain":{"content":"<Figure size 640x480 with 0 Axes>","content_type":"text/plain"}}},"children":[],"key":"OCYkyUJbyY"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"955de931baaf7fe691bb415365f7bba8","path":"/955de931baaf7fe691bb415365f7bba8.png"},"text/plain":{"content":"<Figure size 1500x600 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"QgQ9SSBboX"}],"key":"wy13mPPpZz"}],"key":"wVXTSAGC1Q"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"from IPython.display import Image, display\ndisplay(Image(filename=‘./table1.png’))","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"K5p8ixIev2"}],"key":"rfeqddpZek"}],"key":"M1OmhLoKtu"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"For reference here are the specs from the original PhaseNet paper.  How do they compare?","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FdT5ZEK8zw"}],"key":"f2lDWr07HY"},{"type":"image","url":"/3457a2087d345d421fa2f568f063277a.png","width":800,"key":"BEMw7jLTG0","urlSource":"https://github.com/amtseismo/2025_ML_TSC/blob/main/notebooks/Amanda/table1.png?raw=true"}],"key":"mfFxknMIle"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"8. Compute and plot the pick distribution","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"maOBdfR73B"}],"identifier":"id-8-compute-and-plot-the-pick-distribution","label":"8. Compute and plot the pick distribution","html_id":"id-8-compute-and-plot-the-pick-distribution","implicit":true,"key":"ONPnCqvyS4"}],"key":"LGmFeLnEfF"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"decision_thresholds=[0.5,0.7,0.9]\n\n# Plot the histograms\ncolors = [[0.5,0,0],[0,0,0.5],[0,0.5,0]]\nfig = plt.figure()\nfig, axs = plt.subplots(\n    1, 2,              # 1 row, 2 columns\n    figsize=(15, 6),  # overall figure size\n    sharey=True,       # share y-axis\n    gridspec_kw={\"width_ratios\": [1, 1], \"wspace\": 0.1}  # control layout\n)\n\nfor count, decision_threshold in enumerate(decision_thresholds):\n    # Decision threshold\n    phase=\"P\"\n    phase_data = merged[(merged[\"phase\"] == phase) & (merged[\"pred_val\"] >= decision_threshold) & (merged[\"max_idx\"] != -100)]\n    p_pick_diff = phase_data[\"pred_max_idx\"] - phase_data[\"max_idx\"]\n    phase=\"S\"\n    phase_data = merged[(merged[\"phase\"] == phase) & (merged[\"pred_val\"] >= decision_threshold) & (merged[\"max_idx\"] != -100)]\n    s_pick_diff = phase_data[\"pred_max_idx\"] - phase_data[\"max_idx\"]\n\n    axs[0].hist(p_pick_diff, bins=np.arange(-30.5,30.5,1), rwidth=0.8, color=colors[count], alpha=0.5, edgecolor='black', label=\"decision threshold =\"+'% 6.2f' % decision_threshold)\n    axs[1].hist(s_pick_diff, bins=np.arange(-30.5,30.5,1), rwidth=0.8, color=colors[count], alpha=0.5, edgecolor='black', label=\"decision threshold =\"+'% 6.2f' % decision_threshold)\nplt.legend()\naxs[0].set_xlabel(\"Residual [samples]\",fontsize=14)\naxs[0].set_title(\"P wave\",fontsize=14)\naxs[1].set_title(\"S wave\",fontsize=14)\naxs[0].set_ylabel(\"Frequency\",fontsize=14)\naxs[1].set_xlabel(\"Residual [samples]\",fontsize=14)","key":"TN7a9Ajh1c"},{"type":"outputs","id":"aIkJJFyjHqyoXqusWlSN1","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"text/plain":{"content":"<Figure size 640x480 with 0 Axes>","content_type":"text/plain"}}},"children":[],"key":"HfRrWqVqLs"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"c0f8eafaa95db0d7fe8d20c60388b39a","path":"/c0f8eafaa95db0d7fe8d20c60388b39a.png"},"text/plain":{"content":"<Figure size 1500x600 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"bwbAvYzGOe"}],"key":"WbRRuXuIih"}],"key":"q6iSIOMnzm"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We will leave it as an exercise for the reader compute the mean and standard deviation of the residuals (t < 0.5 s) whose distributions are shown above and compare those to the values reported in table 1.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ARFGqS5hWv"}],"key":"bP82zHDc1C"}],"key":"O8Xnq8EJfn"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"9. Other metrics?","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ywOfkbUN7v"}],"identifier":"id-9-other-metrics","label":"9. Other metrics?","html_id":"id-9-other-metrics","implicit":true,"key":"OlypnRqi10"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"In some cases performance metrics are straightforward and in other cases they are subjective.  The onus is on the researcher to select or design appropriate metrics.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"kj2QDemRq8"}],"key":"ACws3YwyjY"},{"type":"heading","depth":3,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"References","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"kdwaOFyhaw"}],"identifier":"references","label":"References","html_id":"references","implicit":true,"key":"hoJ5SXuIDp"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Zhu, W., & Beroza, G. C. (2019). PhaseNet: A deep-neural-network-based seismic arrival-time picking method. ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"K9oTC5168r"},{"type":"emphasis","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Geophysical Journal International","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"t63sMbl1DB"}],"key":"G5CycBvY5M"},{"type":"text","value":", 216(1), 261–273. ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"OkhlaWEOYg"},{"type":"cite","url":"https://doi.org/10.1093/gji/ggy423","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Zhu & Beroza (2018)","key":"H2f1JZPg9i"}],"kind":"narrative","label":"Zhu_2018","identifier":"https://doi.org/10.1093/gji/ggy423","enumerator":"1","key":"sJlnnlz7Pk"}],"key":"DJQ5L9Tc1Z"}],"key":"LedKmP9Tlm"}],"key":"SSDlBFx0P6"}],"key":"iOiM9Czu1v"}],"key":"aC72AbkVbz"},"references":{"cite":{"order":["Zhu_2018"],"data":{"Zhu_2018":{"label":"Zhu_2018","enumerator":"1","doi":"10.1093/gji/ggy423","html":"Zhu, W., & Beroza, G. C. (2018). PhaseNet: A Deep-Neural-Network-Based Seismic Arrival Time Picking Method. <i>Geophysical Journal International</i>. <a target=\"_blank\" rel=\"noreferrer\" href=\"https://doi.org/10.1093/gji/ggy423\">10.1093/gji/ggy423</a>","url":"https://doi.org/10.1093/gji/ggy423"}}}}}